var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _objectSpread2=_interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));var _getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));var _inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits"));var React=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _reactNativeReanimated=_interopRequireDefault(require("react-native-reanimated"));var _reactNativeGestureHandler=require("react-native-gesture-handler");var _jsxFileName="/Users/osdnk/OSS/react-native-reanimated-bottom-sheet/src/index.tsx";var _Dimensions$get=_reactNative.Dimensions.get('window'),screenHeight=_Dimensions$get.height;var P=function P(android,ios){return _reactNative.Platform.OS==='ios'?ios:android;};var magic={damping:50,mass:0.3,stiffness:121.6,overshootClamping:true,restSpeedThreshold:0.3,restDisplacementThreshold:0.3,deceleration:0.999,bouncyFactor:1,velocityFactor:P(1,0.8),toss:0.4,coefForTranslatingVelocities:5};var damping=magic.damping,mass=magic.mass,stiffness=magic.stiffness,overshootClamping=magic.overshootClamping,restSpeedThreshold=magic.restSpeedThreshold,restDisplacementThreshold=magic.restDisplacementThreshold,deceleration=magic.deceleration,velocityFactor=magic.velocityFactor,toss=magic.toss;var set=_reactNativeReanimated.default.set,cond=_reactNativeReanimated.default.cond,onChange=_reactNativeReanimated.default.onChange,block=_reactNativeReanimated.default.block,eq=_reactNativeReanimated.default.eq,greaterOrEq=_reactNativeReanimated.default.greaterOrEq,sqrt=_reactNativeReanimated.default.sqrt,not=_reactNativeReanimated.default.not,defined=_reactNativeReanimated.default.defined,max=_reactNativeReanimated.default.max,add=_reactNativeReanimated.default.add,and=_reactNativeReanimated.default.and,Value=_reactNativeReanimated.default.Value,spring=_reactNativeReanimated.default.spring,or=_reactNativeReanimated.default.or,divide=_reactNativeReanimated.default.divide,greaterThan=_reactNativeReanimated.default.greaterThan,sub=_reactNativeReanimated.default.sub,event=_reactNativeReanimated.default.event,diff=_reactNativeReanimated.default.diff,multiply=_reactNativeReanimated.default.multiply,clockRunning=_reactNativeReanimated.default.clockRunning,startClock=_reactNativeReanimated.default.startClock,stopClock=_reactNativeReanimated.default.stopClock,decay=_reactNativeReanimated.default.decay,Clock=_reactNativeReanimated.default.Clock,lessThan=_reactNativeReanimated.default.lessThan,call=_reactNativeReanimated.default.call,lessOrEq=_reactNativeReanimated.default.lessOrEq,neq=_reactNativeReanimated.default.neq;function runDecay(clock,value,velocity,wasStartedFromBegin){var state={finished:new Value(0),velocity:new Value(0),position:new Value(0),time:new Value(0)};var config={deceleration:deceleration};return[cond(clockRunning(clock),0,[cond(wasStartedFromBegin,0,[set(wasStartedFromBegin,1),set(state.finished,0),set(state.velocity,multiply(velocity,velocityFactor)),set(state.position,value),set(state.time,0),startClock(clock)])]),cond(clockRunning(clock),decay(clock,state,config)),cond(state.finished,stopClock(clock)),state.position];}function withPreservingAdditiveOffset(drag,state){var prev=new Value(0);var valWithPreservedOffset=new Value(0);return block([cond(eq(state,_reactNativeGestureHandler.State.BEGAN),[set(prev,0)],[set(valWithPreservedOffset,add(valWithPreservedOffset,sub(drag,prev))),set(prev,drag)]),valWithPreservedOffset]);}function withDecaying(drag,state,decayClock,velocity,prevent){var valDecayed=new Value(0);var offset=new Value(0);var wasStartedFromBegin=new Value(0);return block([cond(eq(state,_reactNativeGestureHandler.State.END),[cond(prevent,stopClock(decayClock),set(valDecayed,runDecay(decayClock,add(drag,offset),velocity,wasStartedFromBegin)))],[stopClock(decayClock),cond(eq(state,_reactNativeGestureHandler.State.BEGAN),set(prevent,0)),cond(or(eq(state,_reactNativeGestureHandler.State.BEGAN),eq(state,_reactNativeGestureHandler.State.ACTIVE)),set(wasStartedFromBegin,0)),cond(eq(state,_reactNativeGestureHandler.State.BEGAN),[set(offset,sub(valDecayed,drag))]),set(valDecayed,add(drag,offset))]),valDecayed]);}var BottomSheetBehavior=function(_React$Component){(0,_inherits2.default)(BottomSheetBehavior,_React$Component);function BottomSheetBehavior(props){var _this;(0,_classCallCheck2.default)(this,BottomSheetBehavior);_this=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(BottomSheetBehavior).call(this,props));_this.decayClock=new Clock();_this.panState=new Value(0);_this.tapState=new Value(0);_this.velocity=new Value(0);_this.panMasterState=new Value(_reactNativeGestureHandler.State.END);_this.masterVelocity=new Value(0);_this.isManuallySetValue=new Value(0);_this.manuallySetValue=new Value(0);_this.masterClockForOverscroll=new Clock();_this.preventDecaying=new Value(0);_this.dragMasterY=new Value(0);_this.dragY=new Value(0);_this.onOpenStartValue=new Value(0);_this.onOpenEndValue=new Value(0);_this.onCloseStartValue=new Value(1);_this.onCloseEndValue=new Value(0);_this.handleMasterPan=event([{nativeEvent:{translationY:_this.dragMasterY,state:_this.panMasterState,velocityY:_this.masterVelocity}}]);_this.handlePan=event([{nativeEvent:{translationY:_this.props.enabledInnerScrolling?_this.dragY:_this.dragMasterY,state:_this.props.enabledInnerScrolling?_this.panState:_this.panMasterState,velocityY:_this.props.enabledInnerScrolling?_this.velocity:_this.masterVelocity}}]);_this.handleTap=event([{nativeEvent:{state:_this.tapState}}]);_this.snapTo=function(index){if(!_this.props.enabledImperativeSnapping){return;}_this.manuallySetValue.setValue(_this.state.snapPoints[_this.state.propsToNewIndices[index]]);_this.isManuallySetValue.setValue(1);};_this.height=new Value(0);_this.handleLayoutHeader=function(_ref){var heightOfHeader=_ref.nativeEvent.layout.height;_this.state.heightOfHeaderAnimated.setValue(heightOfHeader);_this.setState({heightOfHeader:heightOfHeader});};_this.handleFullHeader=function(_ref2){var height=_ref2.nativeEvent.layout.height;return _this.height.setValue(height);};_this.handleLayoutContent=function(_ref3){var height=_ref3.nativeEvent.layout.height;return _this.state.heightOfContent.setValue(height-_this.state.initSnap);};_this.panRef=props.innerGestureHandlerRefs[0];_this.master=props.innerGestureHandlerRefs[1];_this.tapRef=props.innerGestureHandlerRefs[2];_this.state=BottomSheetBehavior.getDerivedStateFromProps(props,undefined);var _this$state=_this.state,snapPoints=_this$state.snapPoints,init=_this$state.init;var middlesOfSnapPoints=[];for(var i=1;i<snapPoints.length;i++){middlesOfSnapPoints.push(divide(add(snapPoints[i-1],snapPoints[i]),2));}var masterOffseted=new Value(init);var tossForMaster=props.springConfig.hasOwnProperty('toss')&&props.springConfig.toss!=undefined?props.springConfig.toss:toss;var destinationPoint=add(masterOffseted,multiply(tossForMaster,_this.masterVelocity));var currentSnapPoint=function currentSnapPoint(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;return i+1===snapPoints.length?snapPoints[i]:cond(lessThan(destinationPoint,middlesOfSnapPoints[i]),snapPoints[i],currentSnapPoint(i+1));};_this.snapPoint=currentSnapPoint();var masterClock=new Clock();var prevMasterDrag=new Value(0);var wasRun=new Value(0);_this.translateMaster=block([cond(eq(_this.panMasterState,_reactNativeGestureHandler.State.END),[set(prevMasterDrag,0),cond(or(clockRunning(masterClock),not(wasRun),_this.isManuallySetValue),[cond(_this.isManuallySetValue,stopClock(masterClock)),set(masterOffseted,_this.runSpring(masterClock,masterOffseted,_this.masterVelocity,cond(_this.isManuallySetValue,_this.manuallySetValue,_this.snapPoint),wasRun,_this.isManuallySetValue)),set(_this.isManuallySetValue,0)])],[stopClock(masterClock),set(_this.preventDecaying,1),set(masterOffseted,add(masterOffseted,sub(_this.dragMasterY,prevMasterDrag))),set(prevMasterDrag,_this.dragMasterY),set(wasRun,0),cond(eq(_this.panMasterState,_reactNativeGestureHandler.State.BEGAN),stopClock(_this.masterClockForOverscroll))]),cond(greaterThan(masterOffseted,snapPoints[0]),masterOffseted,max(multiply(sub(snapPoints[0],sqrt(add(1,sub(snapPoints[0],masterOffseted)))),!props.enabledInnerScrolling?props.overdragResistanceFactor:0),masterOffseted))]);_this.Y=_this.withEnhancedLimits(withDecaying(withPreservingAdditiveOffset(_this.dragY,_this.panState),_this.panState,_this.decayClock,_this.velocity,_this.preventDecaying),masterOffseted);return _this;}(0,_createClass2.default)(BottomSheetBehavior,[{key:"runSpring",value:function runSpring(clock,value,velocity,dest,wasRun){var isManuallySet=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var state={finished:new Value(0),velocity:new Value(0),position:new Value(0),time:new Value(0)};var config=(0,_objectSpread2.default)({damping:damping,mass:mass,stiffness:stiffness,overshootClamping:overshootClamping,restSpeedThreshold:restSpeedThreshold,restDisplacementThreshold:restDisplacementThreshold,toValue:new Value(0)},this.props.springConfig);return[cond(clockRunning(clock),0,[set(state.finished,0),set(state.velocity,velocity),set(state.position,value),set(config.toValue,dest),cond(and(wasRun,not(isManuallySet)),0,startClock(clock)),cond(defined(wasRun),set(wasRun,1))]),spring(clock,state,config),cond(state.finished,stopClock(clock)),state.position];}},{key:"withEnhancedLimits",value:function withEnhancedLimits(val,masterOffseted){var wasRunMaster=new Value(0);var min=multiply(-1,add(this.state.heightOfContent,this.state.heightOfHeaderAnimated));var prev=new Value(0);var limitedVal=new Value(0);var diffPres=new Value(0);var flagWasRunSpring=new Value(0);var justEndedIfEnded=new Value(1);var wasEndedMasterAfterInner=new Value(1);var prevMaster=new Value(1);var prevState=new Value(0);var rev=new Value(0);return block([set(rev,limitedVal),cond(or(eq(this.panState,_reactNativeGestureHandler.State.BEGAN),and(eq(this.panState,_reactNativeGestureHandler.State.ACTIVE),eq(prevState,_reactNativeGestureHandler.State.END))),[set(prev,val),set(flagWasRunSpring,0),stopClock(this.masterClockForOverscroll),set(wasRunMaster,0)],[set(limitedVal,add(limitedVal,sub(val,prev))),cond(lessThan(limitedVal,min),set(limitedVal,min))]),set(prevState,this.panState),set(diffPres,sub(prev,val)),set(prev,val),cond(or(greaterOrEq(limitedVal,0),greaterThan(masterOffseted,0)),[cond(eq(this.panState,_reactNativeGestureHandler.State.ACTIVE),set(masterOffseted,sub(masterOffseted,diffPres))),cond(greaterThan(masterOffseted,0),[set(limitedVal,0)]),cond(not(eq(this.panState,_reactNativeGestureHandler.State.END)),set(justEndedIfEnded,1)),cond(or(eq(this.panState,_reactNativeGestureHandler.State.ACTIVE),eq(this.panMasterState,_reactNativeGestureHandler.State.ACTIVE)),set(wasEndedMasterAfterInner,0)),cond(and(eq(prevMaster,_reactNativeGestureHandler.State.ACTIVE),eq(this.panMasterState,_reactNativeGestureHandler.State.END),eq(this.panState,_reactNativeGestureHandler.State.END)),set(wasEndedMasterAfterInner,1)),set(prevMaster,this.panMasterState),cond(and(eq(this.panState,_reactNativeGestureHandler.State.END),not(wasEndedMasterAfterInner),not(eq(this.panMasterState,_reactNativeGestureHandler.State.ACTIVE)),not(eq(this.panMasterState,_reactNativeGestureHandler.State.BEGAN)),or(clockRunning(this.masterClockForOverscroll),not(wasRunMaster))),[set(this.masterVelocity,cond(justEndedIfEnded,diff(val),this.velocity)),set(masterOffseted,this.runSpring(this.masterClockForOverscroll,masterOffseted,diff(val),this.snapPoint,wasRunMaster)),set(this.masterVelocity,0)]),cond(eq(this.panState,_reactNativeGestureHandler.State.END),set(justEndedIfEnded,0)),set(this.preventDecaying,1),0],[set(this.preventDecaying,0),limitedVal])]);}},{key:"render",value:function render(){var _this2=this;return React.createElement(React.Fragment,{__source:{fileName:_jsxFileName,lineNumber:709}},React.createElement(_reactNativeReanimated.default.View,{style:{height:'100%',width:0,position:'absolute'},onLayout:this.handleFullHeader,__source:{fileName:_jsxFileName,lineNumber:710}}),React.createElement(_reactNativeReanimated.default.View,{style:{width:'100%',position:'absolute',zIndex:100,opacity:cond(this.height,1,0),transform:[{translateY:this.translateMaster},{translateY:sub(this.height,this.state.initSnap)}]},__source:{fileName:_jsxFileName,lineNumber:718}},React.createElement(_reactNativeGestureHandler.PanGestureHandler,{enabled:this.props.enabledGestureInteraction&&this.props.enabledHeaderGestureInteraction,ref:this.master,waitFor:this.panRef,onGestureEvent:this.handleMasterPan,onHandlerStateChange:this.handleMasterPan,simultaneousHandlers:this.props.simultaneousHandlers,__source:{fileName:_jsxFileName,lineNumber:734}},React.createElement(_reactNativeReanimated.default.View,{style:{zIndex:101},onLayout:this.handleLayoutHeader,__source:{fileName:_jsxFileName,lineNumber:745}},this.props.renderHeader&&this.props.renderHeader())),React.createElement(_reactNative.View,{style:this.props.enabledInnerScrolling&&{height:this.state.initSnap-this.state.heightOfHeader,overflow:'hidden'},__source:{fileName:_jsxFileName,lineNumber:754}},React.createElement(_reactNativeGestureHandler.PanGestureHandler,{enabled:this.props.enabledGestureInteraction&&this.props.enabledContentGestureInteraction,waitFor:this.master,ref:this.panRef,onGestureEvent:this.handlePan,onHandlerStateChange:this.handlePan,simultaneousHandlers:this.props.simultaneousHandlers,__source:{fileName:_jsxFileName,lineNumber:762}},React.createElement(_reactNativeReanimated.default.View,{__source:{fileName:_jsxFileName,lineNumber:773}},React.createElement(_reactNativeGestureHandler.TapGestureHandler,{ref:this.tapRef,enabled:this.props.enabledGestureInteraction&&this.props.enabledContentGestureInteraction&&this.props.enabledContentTapInteraction,onHandlerStateChange:this.handleTap,simultaneousHandlers:this.props.simultaneousHandlers,__source:{fileName:_jsxFileName,lineNumber:774}},React.createElement(_reactNativeReanimated.default.View,{style:{width:'100%',transform:[{translateY:this.Y}]},onLayout:this.handleLayoutContent,__source:{fileName:_jsxFileName,lineNumber:784}},this.props.renderContent&&this.props.renderContent())))),React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.tapState,cond(eq(this.tapState,_reactNativeGestureHandler.State.BEGAN),stopClock(this.decayClock))),__source:{fileName:_jsxFileName,lineNumber:796}}),this.props.callbackNode&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,set(this.props.callbackNode,divide(this.translateMaster,this.state.snapPoints[this.state.snapPoints.length-1]))),__source:{fileName:_jsxFileName,lineNumber:806}}),(this.props.onOpenStart||this.props.onCloseEnd)&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,[cond(and(lessOrEq(divide(this.translateMaster,this.state.snapPoints[this.state.snapPoints.length-1]),1-(this.props.callbackThreshold?this.props.callbackThreshold:0.01)),neq(this.onOpenStartValue,1)),[call([],function(){if(_this2.props.onOpenStart)_this2.props.onOpenStart();}),set(this.onOpenStartValue,1),cond(defined(this.onCloseEndValue),set(this.onCloseEndValue,0))])]),__source:{fileName:_jsxFileName,lineNumber:820}}),(this.props.onOpenEnd||this.props.onCloseStart)&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,[cond(and(lessOrEq(divide(this.translateMaster,this.state.snapPoints[this.state.snapPoints.length-1]),this.props.callbackThreshold?this.props.callbackThreshold:0.01),neq(this.onOpenEndValue,1)),[call([],function(){if(_this2.props.onOpenEnd)_this2.props.onOpenEnd();}),set(this.onOpenEndValue,1),cond(defined(this.onCloseStartValue),set(this.onCloseStartValue,0))])]),__source:{fileName:_jsxFileName,lineNumber:853}}),(this.props.onCloseStart||this.props.onOpenEnd)&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,[cond(and(greaterOrEq(divide(this.translateMaster,this.state.snapPoints[this.state.snapPoints.length-1]),this.props.callbackThreshold?this.props.callbackThreshold:0.01),neq(this.onCloseStartValue,1)),[call([],function(){if(_this2.props.onCloseStart)_this2.props.onCloseStart();}),set(this.onCloseStartValue,1),cond(defined(this.onCloseStartValue),set(this.onOpenEndValue,0))])]),__source:{fileName:_jsxFileName,lineNumber:885}}),(this.props.onCloseEnd||this.props.onOpenStart)&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,[cond(and(greaterOrEq(divide(this.translateMaster,this.state.snapPoints[this.state.snapPoints.length-1]),1-(this.props.callbackThreshold?this.props.callbackThreshold:0.01)),neq(this.onCloseEndValue,1)),[call([],function(){if(_this2.props.onCloseEnd)_this2.props.onCloseEnd();}),set(this.onCloseEndValue,1),cond(defined(this.onOpenStartValue),set(this.onOpenStartValue,0)),cond(defined(this.onOpenEndValue),set(this.onOpenEndValue,0))])]),__source:{fileName:_jsxFileName,lineNumber:917}}),this.props.contentPosition&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.Y,set(this.props.contentPosition,sub(0,this.Y))),__source:{fileName:_jsxFileName,lineNumber:954}}),this.props.headerPosition&&React.createElement(_reactNativeReanimated.default.Code,{exec:onChange(this.translateMaster,set(this.props.headerPosition,this.translateMaster)),__source:{fileName:_jsxFileName,lineNumber:962}}))));}}],[{key:"getDerivedStateFromProps",value:function getDerivedStateFromProps(props,state){var snapPoints;var sortedPropsSnapPoints=props.snapPoints.map(function(s,i){if(typeof s==='number'){return{val:s,ind:i};}else if(typeof s==='string'){return{val:BottomSheetBehavior.renumber(s),ind:i};}throw new Error("Invalid type for value "+s+": "+typeof s);}).sort(function(_ref4,_ref5){var a=_ref4.val;var b=_ref5.val;return b-a;});if(state&&state.snapPoints){state.snapPoints.forEach(function(s,i){return s.setValue(sortedPropsSnapPoints[0].val-sortedPropsSnapPoints[i].val);});snapPoints=state.snapPoints;}else{snapPoints=sortedPropsSnapPoints.map(function(p){return new Value(sortedPropsSnapPoints[0].val-p.val);});}var propsToNewIndices={};sortedPropsSnapPoints.forEach(function(_ref6,i){var ind=_ref6.ind;return propsToNewIndices[ind]=i;});var initialSnap=props.initialSnap;return{init:sortedPropsSnapPoints[0].val-sortedPropsSnapPoints[propsToNewIndices[initialSnap]].val,propsToNewIndices:propsToNewIndices,heightOfHeaderAnimated:state&&state.heightOfHeaderAnimated||new Value(0),heightOfContent:state&&state.heightOfContent||new Value(0),initSnap:sortedPropsSnapPoints[0].val,snapPoints:snapPoints,heightOfHeader:state&&state.heightOfHeader||0};}}]);return BottomSheetBehavior;}(React.Component);exports.default=BottomSheetBehavior;BottomSheetBehavior.defaultProps={overdragResistanceFactor:0,initialSnap:0,enabledImperativeSnapping:true,enabledGestureInteraction:true,enabledHeaderGestureInteraction:true,enabledContentGestureInteraction:true,enabledContentTapInteraction:true,enabledInnerScrolling:true,springConfig:{},innerGestureHandlerRefs:[React.createRef(),React.createRef(),React.createRef()],callbackThreshold:0.01};BottomSheetBehavior.renumber=function(str){return Number(str.split('%')[0])*screenHeight/100;};
//# sourceMappingURL=index.js.map